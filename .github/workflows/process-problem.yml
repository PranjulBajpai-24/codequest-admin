name: Process Approved Problem

on:
  push:
    branches:
      - main
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:
    inputs:
      problem_path:
        description: "Path to the problem directory (e.g., problem-submissions/my-problem)"
        required: true
        type: string

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout admin repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ADMIN_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Ensure full git history
        run: git fetch --prune --unshallow || true

      - name: Get changed problem directories
        id: changed_dirs
        run: |
          CHANGED_DIRS=$(git diff --name-only HEAD~1 HEAD | grep "^problem-submissions/" | cut -d'/' -f1-2 | sort -u)
          echo "dirs=$CHANGED_DIRS" >> $GITHUB_ENV

      - name: Process each problem
        run: |
          for dir in ${{ env.dirs }}; do
            echo "🔍 Final validation of $dir"
            node scripts/validate-problem.js "$dir"
            echo "🛠️ Generating boilerplate for $dir"
            node tools/boilerplate-generator/index.js "$dir"
            echo "📦 Preparing problem for web repository..."
            PROBLEM_NAME=$(basename "$dir")
            mkdir -p processed-problems
            cp -r "$dir" "processed-problems/$PROBLEM_NAME"
            printf '%s\n' \
              "{" \
              "  \"id\": \"$PROBLEM_NAME\"," \
              "  \"processedAt\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"," \
              "  \"status\": \"approved\"," \
              "  \"version\": \"1.0.0\"" \
              "}" > "processed-problems/$PROBLEM_NAME/metadata.json"
            echo "✅ Problem prepared: $PROBLEM_NAME"
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add processed-problems/
            git commit -m "Process problem: $PROBLEM_NAME" || exit 0
            git push
          done

      - name: Trigger sync to web repository
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.WEB_REPO_TOKEN }}
          script: |
            const changedDirs = process.env.dirs ? process.env.dirs.split(' ') : [];
            for (const dir of changedDirs) {
              const problemName = dir.split('/').pop();
              await github.rest.actions.createWorkflowDispatch({
                owner: 'gaurav-singhh',
                repo: 'codequest-web',
                workflow_id: 'sync-problems.yml',
                ref: 'main',
                inputs: {
                  problem_name: problemName,
                  source_repo: context.repo.repo,
                  source_owner: context.repo.owner
                }
              });
              console.log(`Triggered sync for problem: ${problemName}`);
            }
